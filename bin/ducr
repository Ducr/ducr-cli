#! /usr/bin/env node

const { chalk, commander, minimist } = require('../libs/tools/module')
const packageData = require('../package.json')
const log = console.log

// å½“å‰cliçš„åç§°
const cliName = packageData.name

log(chalk.yellowBright.bold(`ğŸ‘ welcome to use ${cliName}ğŸ‘`))

/**
 * å‚æ•°çš„æ ¼å¼åŒ–æ–¹æ³•ï¼Œé…åˆminimistå¤„ç†è¾“å‡ºé”®å€¼å¯¹å‚æ•°
 * @param { object } cmd å½“å‰å‘½ä»¤è¡Œä¸­çš„å‘½ä»¤æ•°æ®
 */
const handleArgs = (cmd = {}) => {
  // å‘½ä»¤è¡Œä¼ å‚çš„æ•°ç»„ï¼Œæ ¼å¼ä¸ºï¼š[ 'create', 'demo', '-o', 'Ducr', '-r', 'ducr-template' ]
  // éœ€å¤„ç†ä¸º [ 'create', 'demo', '--owner', 'Ducr', '--repository', 'ducr-template' ]
  let argvList = process.argv.splice(2) || []
  const { options } = cmd
  options.forEach(opt => {
    argvList = argvList.map(argv => {
      let newArgv = argv
      if (opt.short === argv || opt.long === argv) {
        newArgv = opt.long
      }
      return newArgv
    })
  })
  return minimist(argvList)
}

// åˆ›å»ºcreateå‘½ä»¤ å¹¶è¿›è¡Œæ“ä½œ
commander.command('create <app-name>')
  .description("create a new project")
  .option("-f,--force", 'overwrite target if it exists') // ä¸€äº›å‚æ•°é…ç½®åŠç®€å†™å½¢å¼
  .option("-o,--owner", 'overwrite target if it exists') // ownerå‚æ•°é…ç½®åŠç®€å†™å½¢å¼
  .option("-r,--repository", 'overwrite target if it exists') // repositoryå‚æ•°é…ç½®åŠç®€å†™å½¢å¼
  .action((name, cmd) => { // è¾“å…¥æ­£ç¡®å‘½ä»¤ä¹‹åçš„æ“ä½œï¼Œname æ˜¯å‘½ä»¤ï¼Œcmd æ˜¯å‚æ•°
    if (!name) {
      log(chalk.red("please write project name"))
      return
    }
    require('../libs/command/create.js')(name, handleArgs(cmd))
  })

// ducr-cli çš„ç‰ˆæœ¬ä¿¡æ¯
commander
  .version(`${cliName}@${packageData.version}`)
  .usage('<command> [option]')

// åœ¨ --help çš„æ—¶å€™è¿›è¡Œè°ƒæ•´
commander.on('--help', () => {
  log(`Run ${chalk.red(`${cliName} <command> --help`)} show details`)
})

// è§£æç”¨æˆ·æ‰§è¡Œå‘½ä»¤æ—¶å€™ä¼ å…¥çš„å‚æ•°ï¼Œæ ¹æ®å‚æ•°è¿›è¡Œé…ç½® 
commander.parse(process.argv)

if (!commander.args.length) {
  commander.help()
}
